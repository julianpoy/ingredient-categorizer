version: 2.1

orbs:
  docker: circleci/docker@2.2.0

jobs:
  build-amd64:
    machine:
      image: ubuntu-2404:current
    resource_class: medium
    steps:
      - checkout

      - run:
          name: Download trained model
          command: |
            curl -L https://recipesage-ml.s3.us-west-2.amazonaws.com/models/grocery-categorizer/ingredient-categorizer-model.tar.gz | tar xzf -

      - run:
          name: Login to DockerHub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - run:
          name: Build and Push AMD64 Image
          command: |
            if [ "${CIRCLE_BRANCH}" = "main" ]; then
              TAG="latest"
            else
              TAG="${CIRCLE_BRANCH}"
            fi

            COMMIT_TAG="${CIRCLE_SHA1:0:7}"

            docker build \
              --platform linux/amd64 \
              --tag "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}-amd64" \
              --tag "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}-amd64" \
              .

            docker push "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}-amd64"
            docker push "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}-amd64"

  build-arm64:
    machine:
      image: ubuntu-2404:current
    resource_class: arm.medium
    steps:
      - checkout

      - run:
          name: Download trained model
          command: |
            curl -L https://recipesage-ml.s3.us-west-2.amazonaws.com/models/grocery-categorizer/ingredient-categorizer-model.tar.gz | tar xzf -

      - run:
          name: Login to DockerHub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - run:
          name: Build and Push ARM64 Image
          command: |
            if [ "${CIRCLE_BRANCH}" = "main" ]; then
              TAG="latest"
            else
              TAG="${CIRCLE_BRANCH}"
            fi

            COMMIT_TAG="${CIRCLE_SHA1:0:7}"

            docker build \
              --platform linux/arm64 \
              --tag "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}-arm64" \
              --tag "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}-arm64" \
              .

            docker push "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}-arm64"
            docker push "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}-arm64"

  create-manifest:
    docker:
      - image: cimg/base:current
    steps:
      - run:
          name: Login to DockerHub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - run:
          name: Create and Push Multi-Arch Manifest
          command: |
            if [ "${CIRCLE_BRANCH}" = "main" ]; then
              TAG="latest"
            else
              TAG="${CIRCLE_BRANCH}"
            fi

            COMMIT_TAG="${CIRCLE_SHA1:0:7}"

            # Create and push manifest for branch/latest tag
            docker manifest create "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}" \
              "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}-amd64" \
              "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}-arm64"

            docker manifest push "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${TAG}"

            # Create and push manifest for commit tag
            docker manifest create "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}" \
              "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}-amd64" \
              "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}-arm64"

            docker manifest push "${DOCKERHUB_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${COMMIT_TAG}"

workflows:
  version: 2
  build-deploy:
    jobs:
      - build-amd64:
          context: dockerhub
          filters:
            branches:
              only:
                - main
                - develop
      - build-arm64:
          context: dockerhub
          filters:
            branches:
              only:
                - main
                - develop
      - create-manifest:
          context: dockerhub
          requires:
            - build-amd64
            - build-arm64
          filters:
            branches:
              only:
                - main
                - develop
